{% extends 'core/base.html' %}

{% block baseblock %}
  <h1>Checkout</h1>
  <form id="checkout-form" method="post">
    {% csrf_token %}
    
    <div class="form-group">
      <label for="id_first_name">First Name:</label>
      <input type="text" class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" id="id_first_name" name="first_name" value="{{ form.first_name.value }}" required>
      {% for error in form.first_name.errors %}
        <div class="invalid-feedback">
          {{ error }}
        </div>
      {% endfor %}
    </div>

    <div class="form-group">
      <label for="id_last_name">Last Name:</label>
      <input type="text" class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" id="id_last_name" name="last_name" value="{{ form.last_name.value }}" required>
      {% for error in form.last_name.errors %}
        <div class="invalid-feedback">
          {{ error }}
        </div>
      {% endfor %}
    </div>

    <div class="form-group">
      <label for="id_email">Email:</label>
      <input type="email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" id="id_email" name="email" value="{{ form.email.value }}" required>
      {% for error in form.email.errors %}
        <div class="invalid-feedback">
          {{ error }}
        </div>
      {% endfor %}
    </div>

    <div class="form-group">
      <label for="id_phone">Phone:</label>
      <input type="text" class="form-control {% if form.phone.errors %}is-invalid{% endif %}" id="id_phone" name="phone" value="{{ form.phone.value }}" required>
      {% for error in form.phone.errors %}
        <div class="invalid-feedback">
          {{ error }}
        </div>
      {% endfor %}
    </div>

    <div class="form-group">
      <label for="id_address">Address:</label>
      <input type="text" class="form-control {% if form.address.errors %}is-invalid{% endif %}" id="id_address" name="address" value="{{ form.address.value }}" required>
      {% for error in form.address.errors %}
        <div class="invalid-feedback">
          {{ error }}
        </div>
      {% endfor %}
    </div>

    <div class="form-group">
      <label for="id_zipcode">Zipcode:</label>
      <input type="text" class="form-control {% if form.zipcode.errors %}is-invalid{% endif %}" id="id_zipcode" name="zipcode" value="{{ form.zipcode.value }}" required>
      {% for error in form.zipcode.errors %}
        <div class="invalid-feedback">
          {{ error }}
        </div>
      {% endfor %}
    </div>

    <div class="form-group">
      <label for="id_city">City:</label>
      <input type="text" class="form-control {% if form.city.errors %}is-invalid{% endif %}" id="id_city" name="city" value="{{ form.city.value }}" required>
      {% for error in form.city.errors %}
        <div class="invalid-feedback">
          {{ error }}
        </div>
      {% endfor %}
    </div>

    <h3>Order Summary</h3>
    <ul>
      {% for item in cart.items.all %}
        <li>
          {{ item.product.name }} - {{ item.quantity }} - ₹{{ item.product.price }}
          <form action="{% url 'increment_quantity' item.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit">+</button>
          </form>
          <form action="{% url 'decrement_quantity' item.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit">-</button>
          </form>
          <form action="{% url 'remove_from_cart' item.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Remove</button>
          </form>
        </li>
      {% endfor %}
    </ul>
    <p>Total Price: ₹{{ total_price }}</p>
    
    <h3>Payment</h3>
    <button id="rzp-button1">Pay with Razorpay</button>
  </form>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ amount }}", 
        "currency": "INR",
        "name": "Your Store Name",
        "description": "Order #{{ order.id }}",
        "order_id": "{{ order.razorpay_order_id }}",
        "handler": function (response){
            document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
            document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
            document.getElementById('razorpay_signature').value = response.razorpay_signature;
            document.getElementById('checkout-form').submit();
        },
        "prefill": {
            "name": "{{ order.first_name }} {{ order.last_name }}",
            "email": "{{ order.email }}",
            "contact": "{{ order.phone }}"
        },
        "theme": {
            "color": "#3399cc"
        }
    };
    var rzp1 = new Razorpay(options);
    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    }
  </script>
{% endblock %}
